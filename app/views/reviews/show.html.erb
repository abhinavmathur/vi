<% user = User.find(@review.reviewer_id) %>
<% product = @review.reviewfiable %>
<link rel="author" href="<%= user.google_plus %>">
<div class="row">
  <div class="col s12 breadcrumbs-review">
    <a href="/" class="breadcrumb">Vivieu</a>
    <a href="#" class="breadcrumb">Second</a>
    <a href="#" class="breadcrumb">Third</a>
  </div>
  <div class="row title-review">
    <div class="col s12 m8">
      <h3 class="title-imp white-text">
        <%= @review.title %>
      </h3>
    </div>

    <div class="col s4">
      <div class="row valign-wrapper">
        <div class="col s4">
          <img src="<%= user.avatar %>" alt="" class="reviewer-image-review">
        </div>
        <div class="col s8">
          <h5 class="white-text truncate flow-text">
            <%= user.username %>
          </h5>
          <span><%= @review.created_at.to_time %></span>
          <%= link_to 'Check my Reviews', user_path(user), class: 'btn waves-effect white black-text'%>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col s12 m8 l8 review-panel">
    <div class="video">
      <iframe width="854" height="480"
              src="https://www.youtube.com/embed/<%= @review.youtube_url %>">
      </iframe>
    </div>

    <div class="card-panel white">
      <%= simple_format(SimpleText.new(@review.description, @review).get_text, class: 'flow-text review-description') %>
    </div>

    <div class="related-reviews">
      <% related_reviews =  Review.where(reviewer_id: @review.reviewer_id).where('id != ?', @review.id).all %>
      <% if related_reviews.size == 0 %>
          <p class="center flow-text">No other reviews by this reviewer</p>
      <% else %>
          <% related_reviews.take(4).each do |review| %>
              <div class="col s10 m6 l3 offset-s1">
                <div class="card" style="min-height: 270px !important; max-height: 270px !important">
                  <div class="card-image">
                    <img src="http://i3.ytimg.com/vi/<%= review.youtube_url %>/hqdefault.jpg">
                  </div>
                  <div class="card-content">
                    <h6><%= link_to truncate(review.title, length: 50), review_path(review) %></h6>
                    <div class="chip">
                      <img src="<%= user.avatar %>" alt="Reviewer picture">
                      <small class="truncate"><%= user.username %></small>
                    </div>
                  </div>
                </div>
              </div>
          <% end %>
      <% end %>
    </div>

    <% if @review.amazon_ad.present? %>
        <%= render 'reviews/partials/amazon_ad', review: @review %>
    <% end %>
  </div>


  <div class="col s12 m4 l4">

    <div class="card">
      <div class="card-content center">
        <span class="card-title"><%= @review.reviewfiable.title %></span>
        <br>
        <br>
        <div class="row">
          <div class="col s12">
            <div class="center">
              <a class="modal-trigger waves-effect waves-light btn" href="#modal1">Manufacturer Description</a>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col s12">
            <% if product.asin.present? %>
                <img src="http://images.amazon.com/images/P/<%= product.asin %>.01.LZZZZZZZ.jpg"
                     class="materialboxed responsive-img"
                     alt="image for <%= product.title %>" data-caption="<%= product.title %>">
            <% elsif product.product_images.present? %>
                <% first_image = product.product_images.split(',').first %>
                <img src="<%= first_image %>" alt="<%= product %> image">
            <% else %>
                <%= image_tag('no.png') %>
            <% end %>
            <%= link_to redirect_to_website_review_path(affiliate_website: @review.affiliate_link),
                        class: 'waves-effect waves-light red btn-large',method: :post, target: '_blank' do%>
                Visit the website<i class="material-icons right">send</i>
            <% end %>
            <p class="center">(Link opens in new tab)</p>
          </div>
        </div>


      </div>
    </div>

    <% if product.reviews.count > 1 %>
        <div class="row">
          <div class="col s12">
            <h2 class="flow-text teal-text center">Similar Reviews</h2>
            <ul class="collection">
              <% product.reviews.where.not(id: @review.id).take(4).each do |review| %>
                  <li class="collection-item avatar">
                    <%= link_to review.title do %>
                        <i class="material-icons circle light-blue">play_arrow</i>

                    <% end %>
                    <span class="title truncate"><%= link_to review.title, review_path(review) %></span>
                    <div class="chip">
                      <%review_user = User.find(review.reviewer_id) %>
                      <%= link_to review_user.username, user_path(review_user) %>
                    </div>
                  </li>
              <% end %>
            </ul>
            <% if product.reviews.count > 4 %>
                <%= link_to 'View all reviews for this product', product_path(product) %>
            <% end %>
          </div>
        </div>
    <% end %>

    <div class="row">
      <div class="col s12 recommended-reviews">
        <h2 class="flow-text center">Recommended Reviews</h2>
        <% review_items = Review.where('id != ?', @review.id).take(10) %>
        <!--If not current_user, then show top 10 reviews-->
        <% unless current_user %>
            <% review_items.each do |review| %>
                <% review_user = User.find(review.reviewer_id) %>
                <%= render partial: 'reviews/partials/recommended_reviews',
                           locals: { review: review, user: review_user } %>
            <% end %>
        <% else %>
            <% if current_user.recommended_reviews.count < 10 %>
                <% review_items.each do |review| %>
                    <% review_user = User.find(review.reviewer_id) %>
                    <%= render partial: 'reviews/partials/recommended_reviews',
                               locals: { review: review, user: review_user } %>
                <% end %>
            <% else %>
                <%  current_user.recommended_reviews.each do |review| %>
                    <%review_user = User.find(review.reviewer_id) %>
                    <%= render partial: 'reviews/partials/recommended_reviews',
                               locals: { review: review, user: review_user } %>
                <% end %>
            <% end %>
        <% end %>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <script type="text/javascript">
          amzn_assoc_placement = "adunit0";
          amzn_assoc_search_bar = "false";
          amzn_assoc_tracking_id = "raaaaj5000-20";
          amzn_assoc_search_bar_position = "top";
          amzn_assoc_ad_mode = "search";
          amzn_assoc_ad_type = "smart";
          amzn_assoc_marketplace = "amazon";
          amzn_assoc_region = "US";
          amzn_assoc_title = "You might like...";
          amzn_assoc_default_search_phrase = "<%= @review.reviewfiable.title %>";
          amzn_assoc_default_category = "All";
          amzn_assoc_linkid = "2cc17c8830b0429d93f605725d681968";
        </script>
        <script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>
      </div>
    </div>



  </div>
</div>

<!-- Modal Structure -->
<div id="modal1" class="modal modal-fixed-footer">
  <div class="modal-content">
    <h4 class="title-imp center"><%= @review.reviewfiable.title %></h4>
    <div class="card-panel">
      <p><%= @review.reviewfiable.description.html_safe %></p>
    </div>
  </div>
  <div class="modal-footer">
    <small>Click outside of the box to close</small>
    <%= link_to redirect_to_website_review_path(affiliate_website: @review.affiliate_link),
                class: 'waves-effect waves-light red btn right',method: :post, target: '_blank' do%>
        View the website<i class="material-icons right">send</i>
    <% end %>
    <%= link_to 'View More', product_path(@review.reviewfiable), class: 'modal-action modal-close waves-effect light-blue btn-flat' %>
  </div>
</div>

<div class="container">
  <%= commontator_thread(@review) %>
</div>

<% unless user_signed_in? %>
    <div id="modal2" class="modal">
      <div class="modal-content">
        <h4>Login Required</h4>
        <%= link_to "Sign in with Google", user_google_oauth2_omniauth_authorize_path %>
      </div>
      <div class="modal-footer">
        <small>Click outside the box to close</small>
      </div>
    </div>
<% end %>


<%= render 'javascripts/reviews/show' %>